<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DegenMint DApp</title>
    <link rel="stylesheet" href="styles.css">
  <style>body {
    font-family: Arial, sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    background-color: #f0f0f0;
}

.container {
    text-align: center;
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
}

.progress-bar {
    width: 200px;
    height: 20px;
    background-color: #e0e0e0;
    margin: 20px auto;
    border-radius: 10px;
    position: relative;
}

.progress {
    height: 100%;
    background: #4CAF50;
    border-radius: 10px;
    transition: width 0.5s ease;
}

#percentage {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: black;
    font-weight: bold;
}

button {
    margin: 10px;
    padding: 10px 20px;
    font-size: 16px;
    cursor: pointer;
}

input {
    margin: 10px;
    padding: 5px;
    font-size: 16px;
}

#status {
    margin-top: 20px;
    color: red; /* Menandai pesan status dengan warna yang lebih mencolok */
    font-weight: bold;
}</style>
</head>
<body>
    <div class="container">
        <h1>DegenMint</h1>
        <div class="progress-bar">
            <div id="progress" class="progress"></div>
            <div id="percentage"></div>
        </div>
        <button id="connectButton">Connect Wallet</button>
        <button id="mintButton" disabled>Mint Tokens</button>
        <input type="number" id="mintAmount" placeholder="Amount to mint">
        <div id="status"></div>
    </div>
    <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js" type="application/javascript"></script>
    <script>const connectButton = document.getElementById('connectButton');
const mintButton = document.getElementById('mintButton');
const mintAmount = document.getElementById('mintAmount');
const progress = document.getElementById('progress');
const percentage = document.getElementById('percentage');
const status = document.getElementById('status');

let provider;
let signer;
let contract;

// Alamat kontrak Anda
const contractAddress = "YOUR_CONTRACT_ADDRESS_HERE"; 
// ABI dari kontrak Anda
const abi = [
    // Add the ABI of your contract here, you can get this from Remix or Truffle
    {
        "inputs": [],
        "name": "getProgress",
        "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [{"internalType": "uint256", "name": "amount", "type": "uint256"}],
        "name": "mint",
        "outputs": [],
        "stateMutability": "payable",
        "type": "function"
    }
];

// Jaringan Base
const baseNetwork = {
    chainId: '0x2105', // ID jaringan Base
    chainName: 'Base',
    nativeCurrency: {
        name: 'Ether',
        symbol: 'ETH',
        decimals: 18
    },
    rpcUrls: ['https://mainnet.base.org'],
    blockExplorerUrls: ['https://basescan.org/']
};

connectButton.addEventListener('click', async () => {
    if (typeof window.ethereum !== 'undefined') {
        try {
            await window.ethereum.request({ method: 'eth_requestAccounts' });
            provider = new ethers.providers.Web3Provider(window.ethereum);
            signer = provider.getSigner();

            // Memeriksa apakah pengguna sudah di jaringan Base
            const { chainId } = await provider.getNetwork();
            if (chainId !== parseInt(baseNetwork.chainId, 16)) {
                status.textContent = "alihkan jaringan ke base";
                await switchToBaseNetwork();
                return; // Keluar dari fungsi jika berhasil beralih atau jika pengguna menolak
            }

            contract = new ethers.Contract(contractAddress, abi, signer);
            connectButton.textContent = "Connected";
            connectButton.disabled = true;
            mintButton.disabled = false;

            // Dapatkan dan perbarui progres saat ini
            await updateProgress();
        } catch (error) {
            if (error.code === 4902) {
                status.textContent = "alihkan jaringan ke base";
                await addBaseNetwork();
            } else {
                status.textContent = "Error connecting to wallet: " + error.message;
            }
        }
    } else {
        status.textContent = "Please install MetaMask!";
    }
});

mintButton.addEventListener('click', async () => {
    if (mintAmount.value && !isNaN(mintAmount.value)) {
        const amount = ethers.utils.parseUnits(mintAmount.value, 18);
        const mintPrice = await contract.MINT_PRICE();
        const totalCost = amount.mul(mintPrice);

        try {
            const tx = await contract.mint(amount, { value: totalCost });
            status.textContent = "Transaction sent, waiting for confirmation...";
            await tx.wait();
            status.textContent = "Tokens minted successfully!";
            await updateProgress();
        } catch (error) {
            status.textContent = "Error minting tokens: " + error.message;
        }
    } else {
        status.textContent = "Please enter a valid number for minting.";
    }
});

async function updateProgress() {
    const currentProgress = await contract.getProgress();
    progress.style.width = `${currentProgress}%`;
    percentage.textContent = `${currentProgress}%`;
}

async function switchToBaseNetwork() {
    try {
        await window.ethereum.request({
            method: 'wallet_switchEthereumChain',
            params: [{ chainId: baseNetwork.chainId }]
        });
        // Jika berhasil beralih, refresh halaman untuk menginisialisasi ulang dengan jaringan baru
        location.reload();
    } catch (switchError) {
        // Jaringan tidak terdaftar, maka tambahkan jaringan
        if (switchError.code === 4902) {
            await addBaseNetwork();
        } else {
            status.textContent = "Failed to switch network: " + switchError.message;
        }
    }
}

async function addBaseNetwork() {
    try {
        await window.ethereum.request({
            method: 'wallet_addEthereumChain',
            params: [baseNetwork]
        });
        // Jika berhasil menambahkan jaringan, refresh halaman untuk menginisialisasi ulang dengan jaringan baru
        location.reload();
    } catch (addError) {
        status.textContent = "Failed to add network: " + addError.message;
    }
}</script>
</body>
</html>
